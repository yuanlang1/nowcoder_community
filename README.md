# 仿写牛客论坛项目

## 使用技术

- SpringMVC
- Spring MyBatis
- Redis
- Kafka
- Elasticsearch
- Spring Security
- Quartz
- Caffeine

## 项目内容

论坛讨论区开发，包括发帖，私信，用户注册，网站流量统计，点赞，关注等功能

### 1. 登录板块

- 注册功能
    - 对应实体类
    - 使用`Spring Main`发送邮件功能
    - 发送成功后，激活账号(第一次激活，重复激活，无效激活链接)
    - 提交用户注册数据
- 登录功能
    - 生成验证码，使用`Kaptcha`生成验证码以及图片
        - 将验证码`ID`添加到`Response`的`Cookie`中，同时保存验证码`ID`以及验证码到`Redis`里面，设置到期时间为60s
    - 验证账号，密码，验证码
        - 验证验证码时，读取到`Cookie`中验证码的ID后，在`Redis`里面找到该验证码信息，进行对比验证，否则过期或错误
    - 登录成功，生成登录凭证
        - 保存`Ticket`到`Redis`中，同时添加到`Cookie`
- 退出功能
    - 将登录凭证修改为失效，修改`Redis`中`Ticket`的状态
    - 跳转至网站首页

### 2. 用户模块

- 显示登录信息
    - 设置拦截器，每个界面都需显示登录信息
        - 请求之前先查到登录用户，从`cookie`里面得到`ticket`，根据`ticket`在`Redis`中找到`ticket`信息，根据`ticket`
          里面的信息找到用户信息
        - 保存用户信息到`TreadLocal`中
    - 显示用户信息
- 账号设置
    - 上传头像
        - 设置`oss`的`secret`,`access`
        - 根据上传的文件名，根据`oss`的上传路径设置文件名，保存到用户信息中
    - 修改密码
- 个人主页
    - 显示用户信息，获赞数量，关注了多少人，粉丝多少人，是否关注该用户
        - 根据`userId`，查询到用户信息
        - 查询`Redis`该用户获赞数量
        - 查询`Redis`中`Set`结构，查询我关注列表得到关注数量 即该用户关注了多少人
        - 查询`Redis`中`Set`结构，查询关注我列表得到关注者数量 即多少人关注该用户
        - 查询`Redis`中...，使用`score`命令查看关注列表是否存在对应的`Id`，得到我是否关注该用户
    - 跳转我关注列表，关注我列表
        - 查询`Redis`得到我关注列表中的用户信息
        - 查询`Redis`得到关注我列表中的用户信息
    - 关注/取消关注
        - 关注该对象，根据对象类型以及`id`得到`key`，添加我到`Redis`中
        - 得到`key`后，去除即可

### 3. 发帖模块

- 过滤敏感词
    - 定义前缀树
    - 编写过滤敏感词方法
- 发布帖子
    - 对应实体类
    - 过滤帖子标题和内容敏感词，将帖子保存到帖子数据库中
    - 发布后显示帖子标题，点赞数量，评论数量
        - 统计帖子点赞数量，查询`Redis`中`Set`结构中，对应帖子`id`以及类型为帖子的`key`的点赞数量
        - 查询评论数据库中，评论对象类型为帖子，对应`id`为该帖子`id`的评论数量
- 帖子信息界面
    - 显示帖子详细信息，标题以及内容
    - 帖子点赞数量，评论数量
    - 点赞/取消点赞
        - 点赞后，`Redis Zset`对应的所有点赞该实体(帖子类型)的用户添加该用户`id`,`Redis Value`对应帖子的用户收到点赞数+1
        - 点击两次，`Redis`中查询到所有点赞该实体(帖子类型)的用户中有该用户，就取消点赞，去除该用户，点赞数-1
    - 评论
        - 显示评论 分页展示
            - 查找评论数据库中评论类型为帖子以及对应的`id`的帖子，按时间拍序
            - 查找评论对象类型为评论的评论，以及对应的`id`
        - 添加评论，添加评论的评论数据库中，评论对象可以为帖子或评论
        - 点赞评论
            - 点赞后，`Redis Zset`对应的所有点赞该实体(评论类型)的用户添加该用户`id`,`Redis Value`对应帖子的用户收到点赞数+1
            - 点击两次，取消点赞，同上操作相反

### 4. 私信模块

- 私信列表
    - 对应实体类
    - 查询会话列表，每个绘画返回最新的私信
    - 查询会话的总消息数
- 未读私信
    - 查询未读私信
    - 进入私信详情过后修改状态为已读
- 私信详情
    - 查询会话中所有私信，按时间顺序展示
- 发送私信
    - 在私信列表/私信详情内发私信

### 5. 统一异常处理

- 使用`@ControllerAdvice`, 其中用`@ExceptionHandler`注解，统一处理异常`Exception.class`

### 6. 优化登录

- 使用`Redis`缓存用户信息，先从缓存中取，抢不到添加缓存
    - 从缓存中取数据
    - 初始化缓存
    - 清除缓存

### 7. 关键字查询帖子(`Elasticsearch`)

- 搜索服务
  - 保存帖子/删除帖子/搜索帖子
    - 保存帖子到`es`中
    - `es`删除帖子
    - 按关键词搜索帖子，高亮返回
- 发布事件
  - 发布帖子时，异步将帖子移交到`es`
  - 删除帖子时，异步删除`es`中该帖子

### 8. 消息队列服务器`kafka`

- 发布系统通知
    - 点赞/评论/关注后，发布系统通知
    - 三类不同的`topic`，时间发生后，生产者生产消息，消费者从队列中读到消息，写入一条评论
- 帖子处理
  - 定义`TOPIC_PUBLISH`的`topic`，发布帖子的时候生产发布帖子消息，消费者消费发布帖子消息，把帖子添加到`es`中
  - 定义`TOPIC_DELETE`的`topic`，删除帖子的时候..., 删除`es`中的帖子

### 9. 权限认证

- 用户登录时基于用户角色
- 设置权限，对请求路径进行权限认证，没有权限处理方案，权限不足处理方案

### 10. 帖子置顶，加精，删除

- 置顶，修改帖子类型
- 加精，删除，修改帖子状态

### 11. 热帖排名(`Quartz`定时计算)

- 当点赞，评论，发帖，加精时帖子分数会变化，将分数变化的帖子放到`Redis`
- 定义定时任务，处理逻辑就是计算帖子分数，根据点赞，评论，发帖，加精的权重计算，随着时间衰减